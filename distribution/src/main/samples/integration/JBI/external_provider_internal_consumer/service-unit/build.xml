<project name="jbi-demo-service-unit" default="build">

  <property name="build.dir" location="./build"/>
  <property name="build.classes.dir" location="${build.dir}/classes"/>
  <property name="build.src.dir" location="${build.dir}/src"/>
  <property name="build.lib.dir" location="${build.dir}/lib"/>
  <property name="src.dir" location="./src"/>
  <property name="wsdl.dir" location="./wsdl"/>

  <property file="../build.properties"/>

  <!-- reuse the macros defined in Celtix samples -->
  <import file="${celtix.home}/samples/common_build.xml"/>        

  <path id="build.classpath">
    <pathelement location="${build.classes.dir}"/>
    <pathelement location="${jbi.sdk.jar}"/>
    <fileset dir="${celtix.home}/lib">
      <include name="celtix.jar"/>
    </fileset>
  </path>
  
  <target name="build" depends="build-service-units"/>

  <target name="generate-code">
    <mkdir dir="${build.src.dir}"/>
    <echo level="info" message="Generating code using wsdl2java..."/>
    <wsdl2java file="hello_world.wsdl"/>
  </target>

  <target name="update-code" description="updates code with actual wsdl location">

    <replace dir="src"  value="${wsdl.dir}${file.separator}">
       <include name="**/*.java"/>
       <replacetoken>@wsdl_path@</replacetoken>
    </replace>

    <!-- for windows make sure that '\' are escaped -->
    <replace dir="src"  value="\\">
       <include name="**/*.java"/>
       <replacetoken>\</replacetoken>
    </replace>

  </target>

  <target name="compile" depends="generate-code">
    <mkdir dir="${build.classes.dir}"/>
    <javac destdir="${build.classes.dir}" srcdir="${build.src.dir}" debug="true">
      <classpath refid="build.classpath"/>
    </javac>
    <javac destdir="${build.classes.dir}" srcdir="${src.dir}" debug="true">
      <classpath refid="build.classpath"/>
    </javac>
  </target>

  <target name="build-service-units" depends="compile">
    <mkdir dir="${build.lib.dir}"/>
    <jar destfile="${build.lib.dir}/celtix-service-consumer.jar">
      <fileset dir="${build.classes.dir}">
	<include name="**/consumer/**/*.class"/>
	<include name="org/**/*.class"/>
      </fileset>
      <metainf dir="./etc/consumer">
	<include name="jbi.xml"/>
      </metainf>
      <metainf dir="./wsdl">
	<include name="hello_world.wsdl"/>
      </metainf>
    </jar>

    <zip destfile="${build.lib.dir}/binding-su.zip">
      <fileset dir="./etc/servicemix-binding-su"/>
      <fileset dir="./wsdl"/>
    </zip>

  </target>

  <target name="clean">
    <delete dir="${build.dir}"/>
  </target>

  <target name="server" description="run demo client">
      <celtixrun classname="test.provider.Server" 
            param1="./wsdl/hello_world.wsdl"/>
  </target>

</project>

