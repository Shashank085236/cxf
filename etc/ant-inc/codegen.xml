<?xml version="1.0"?>
<project name="celtix-codegenerate" basedir="../..">
    <!-- Targets for compiling the codebase -->

    <macrodef name="wsdltojava">
        <attribute name="srcdestdir"/>
        <attribute name="destdir"/>
        <attribute name="file"/>
        <attribute name="package" default="NOT_SPECIFIED"/>
        <sequential>
            <mkdir dir="@{destdir}"/>
            <mkdir dir="@{srcdestdir}"/>
            <condition property="package.arg.@{file}" value="-p @{package}">
                <not>
                    <equals arg1="@{package}" arg2="NOT_SPECIFIED"/>
                </not>
            </condition>
            <property name="package.arg.@{file}" value=""/>
            <java failonerror="true" classname="com.sun.tools.ws.WsImport" fork="true" newenvironment="true">
                <classpath>
                    <fileset dir="${jaxws.home}/lib">
                        <include name="*.jar"/>
                    </fileset>
		    		<path refid="jdk.tools.classpath"/>
                </classpath>
                <sysproperty key="java.util.logging.config.file" value="${basedir}/etc/logging.properties"/>
                <arg line="${package.arg.@{file}}"/>
                <arg value="-keep"/>
                <arg value="-s"/>
                <arg value="@{srcdestdir}"/>
                <arg value="-d"/>
                <arg value="@{destdir}"/>
                <arg value="@{file}"/>
            </java>
        </sequential>
    </macrodef>

    <macrodef name="xsdtojava">
        <attribute name="destdir"/>
        <attribute name="file"/>
        <attribute name="package" default="NOT_SPECIFIED"/>
        <sequential>
            <condition property="package.arg.@{file}" value="-p @{package}">
                <not>
                    <equals arg1="@{package}" arg2="NOT_SPECIFIED"/>
                </not>
            </condition>
            <property name="package.arg.@{file}" value=""/>
            <mkdir dir="@{destdir}"/>
            <java failonerror="true" classname="com.sun.tools.xjc.Driver" fork="true" newenvironment="true">
                <classpath>
                    <fileset dir="${jaxws.home}/lib">
                        <include name="*.jar"/>
                    </fileset>
					<path refid="jdk.tools.classpath"/>
              	</classpath>
                <sysproperty key="java.util.logging.config.file" value="${basedir}/etc/logging.properties"/>
                <arg line="${package.arg.@{file}}"/>
                <arg value="-quiet"/>
                <arg value="-d"/>
                <arg value="@{destdir}"/>
                <arg value="@{file}"/>
            </java>
        </sequential>
    </macrodef>

    <target name="schemas.codegen.internal" unless="schema.codegen.notrequired">
        <xsdtojava file="${basedir}/schemas/ws-addr.xsd" destdir="${basedir}/build/src" package="org.objectweb.celtix.addressing"/>
        <xsdtojava file="${basedir}/schemas/ws-addr-wsdl.xsd" destdir="${basedir}/build/src" package="org.objectweb.celtix.addressing.wsdl"/>
        <xsdtojava file="${basedir}/schemas/wsdl.xsd" destdir="${basedir}/build/src"/>
        <xsdtojava file="${basedir}/schemas/jms-context.xsd" destdir="${basedir}/build/src"/>
        <touch file="${basedir}/build/src/.SCHEMA.CODEGEN.DONE"/>
    </target>

    <target name="schemas.codegen">
        <uptodate property="schema.codegen.notrequired" value="true">
            <srcfiles dir="schemas" includes="*"/>
            <srcfiles dir="etc/ant-inc" includes="codegen.xml"/>
            <mapper type="merge" to="${basedir}/build/src/.SCHEMA.CODEGEN.DONE"/>
        </uptodate>
        <antcall target="schemas.codegen.internal"/>
    </target>
	
    <target name="configuration.codegen.internal" unless="configuration.codegen.notrequired">
        <xsdtojava file="${basedir}/src/org/objectweb/celtix/configuration/config-metadata/types.xsd" destdir="${basedir}/build/src"/>
        <xsdtojava file="${basedir}/src/org/objectweb/celtix/bus/jaxws/config-metadata/types.xsd" destdir="${basedir}/build/src"/>
        <property name="http-metadata.dir" value="${basedir}/build/src/org/objectweb/celtix/bus/transports/http/config-metadata"/>
        <xslt in="schemas/http-conf.xsd" out="${http-metadata.dir}/http-conf-types.xsd" style="${basedir}/etc/transforms/http-conf-types.xsl">
        </xslt>
        <xslt in="schemas/http-conf.xsd" out="${http-metadata.dir}/http-server-config.xml" style="${basedir}/etc/transforms/http-conf.xsl">
            <param name="type" expression="server"/>
        </xslt>
        <xslt in="schemas/http-conf.xsd" out="${http-metadata.dir}/http-client-config.xml" style="${basedir}/etc/transforms/http-conf.xsl">
            <param name="type" expression="client"/>
        </xslt>
        <copy file="schemas/http-conf.xsd" todir="${http-metadata.dir}"/>
        <copy file="schemas/wsdl.xsd" todir="${http-metadata.dir}"/>
        <copy file="schemas/jms.xsd" todir="${http-metadata.dir}"/>
        <copy file="schemas/http-conf.xsd" todir="${http-metadata.dir}"/>
        <xsdtojava file="${http-metadata.dir}/http-conf-types.xsd" destdir="${basedir}/build/src"/>
        <touch file="${basedir}/build/src/.CONFIGURATION.CODEGEN.DONE"/>
    </target>

    <target name="gen">
        <property name="http-metadata.dir" value="${basedir}/build/src/org/objectweb/celtix/bus/transports/http/config-metadata"/>
        <xsdtojava file="${http-metadata.dir}/http-conf-types.xsd" destdir="${basedir}/build/src"/>
    </target>

    <target name="configuration.codegen">
        <uptodate property="configuration.codegen.notrequired" value="true">
            <srcfiles dir="src/org/objectweb/celtix/configuration/config-metadata" includes="types.xsd"/>
            <srcfiles dir="src/org/objectweb/celtix/bus/jaxws/config-metadata" includes="types.xsd"/>
            <srcfiles dir="schemas" includes="http-conf.xsd"/>
            <srcfiles dir="etc/ant-inc" includes="codegen.xml"/>
            <mapper type="merge" to="${basedir}/build/src/.CONFIGURATION.CODEGEN.DONE"/>
        </uptodate>
        <antcall target="configuration.codegen.internal"/>
    </target>

    <target name="type_test.codegen.internal" unless="type_test.codegen.notrequired">
        <mkdir dir="${basedir}/build/wsdl/wsdl/type_test"/>
    	<!-- schema -->
        <xslt style="${basedir}/test/wsdl/type_test/type_test_ID_xsd.xsl"
              in="${basedir}/test/wsdl/type_test/type_test.xsd"
              out="${basedir}/build/wsdl/wsdl/type_test/type_test_1.xsd">
            <param name="groupID" expression="1"/>
        </xslt>
        <xslt style="${basedir}/test/wsdl/type_test/type_test_ID_xsd.xsl"
              in="${basedir}/test/wsdl/type_test/type_test.xsd"
              out="${basedir}/build/wsdl/wsdl/type_test/type_test_2.xsd">
            <param name="groupID" expression="2"/>
        </xslt>
        <xslt style="${basedir}/test/wsdl/type_test/type_test_ID_xsd.xsl"
              in="${basedir}/test/wsdl/type_test/type_test.xsd"
              out="${basedir}/build/wsdl/wsdl/type_test/type_test_3.xsd">
            <param name="groupID" expression="3"/>
        </xslt>
    	<!-- doclit -->
        <xslt style="${basedir}/test/wsdl/type_test/type_test_wsdl.xsl"
              in="${basedir}/test/wsdl/type_test/type_test.xsd"
              out="${basedir}/build/wsdl/wsdl/type_test/type_test_doclit.wsdl">
            <param name="inc_xsd_path" expression="."/>
            <param name="use_style" expression="document"/>
        </xslt>
        <xslt style="${basedir}/test/wsdl/type_test/type_test_soap_wsdl.xsl"
              in="${basedir}/test/wsdl/type_test/type_test.xsd"
              out="${basedir}/build/wsdl/wsdl/type_test/type_test_doclit_soap.wsdl">
            <param name="inc_wsdl_path" expression="."/>
            <param name="use_style" expression="document"/>
        </xslt>
        <wsdltojava file="${basedir}/build/wsdl/wsdl/type_test/type_test_doclit_soap.wsdl"
                    destdir="build/classes-tests/wsdl" 
                    srcdestdir="build/test-src"/>
    	<!-- rpclit -->
        <xslt style="${basedir}/test/wsdl/type_test/type_test_wsdl.xsl"
              in="${basedir}/test/wsdl/type_test/type_test.xsd"
              out="${basedir}/build/wsdl/wsdl/type_test/type_test_rpclit.wsdl">
            <param name="inc_xsd_path" expression="."/>
            <param name="use_style" expression="rpc"/>
        </xslt>
        <xslt style="${basedir}/test/wsdl/type_test/type_test_soap_wsdl.xsl"
              in="${basedir}/test/wsdl/type_test/type_test.xsd"
              out="${basedir}/build/wsdl/wsdl/type_test/type_test_rpclit_soap.wsdl">
            <param name="inc_wsdl_path" expression="."/>
            <param name="use_style" expression="rpc"/>
        </xslt>
        <wsdltojava file="${basedir}/build/wsdl/wsdl/type_test/type_test_rpclit_soap.wsdl"
                    destdir="build/classes-tests/wsdl" 
                    srcdestdir="build/test-src"/>
    	<!-- type test client interface and server impl -->
        <mkdir dir="${basedir}/build/test-src/org/objectweb/celtix/systest/type_test"/>
    	<xslt style="${basedir}/test/wsdl/type_test/type_test_impl_java.xsl"
              in="${basedir}/test/wsdl/type_test/type_test.xsd"
              out="${basedir}/build/test-src/org/objectweb/celtix/systest/type_test/TypeTestImpl.java"/>
        <xslt style="${basedir}/test/wsdl/type_test/type_test_tester_java.xsl"
              in="${basedir}/test/wsdl/type_test/type_test.xsd"
              out="${basedir}/build/test-src/org/objectweb/celtix/systest/type_test/TypeTestTester.java"/>
        <touch file="${basedir}/build/wsdl/wsdl/.TYPE_TEST.CODEGEN.DONE"/>
    </target>

    <target name="type_test.codegen">
    	<mkdir dir="${basedir}/build/wsdl/wsdl"/>
        <uptodate property="type_test.codegen.notrequired" value="true">
            <srcfiles dir="${basedir}/test/wsdl/type_test" includes="*"/>
            <srcfiles dir="etc/ant-inc" includes="codegen.xml"/>
            <mapper type="merge" to="${basedir}/build/wsdl/wsdl/.TYPE_TEST.CODEGEN.DONE"/>
        </uptodate>
        <antcall target="type_test.codegen.internal"/>
    </target>


    <target name="testwsdl.codegen.internal" unless="testwsdl.codegen.notrequired">
       	<wsdltojava file="${basedir}/test/wsdl/hello_world.wsdl" destdir="build/classes-tests/wsdl" srcdestdir="build/test-src"/>
        <wsdltojava file="${basedir}/test/wsdl/hello_world_rpc_lit.wsdl" destdir="build/classes-tests/wsdl" srcdestdir="build/test-src"/>
        <wsdltojava file="${basedir}/test/wsdl/handler_test.wsdl" destdir="build/classes-tests/wsdl" srcdestdir="build/test-src"/>
        <wsdltojava file="${basedir}/test/wsdl/soapheader_test.wsdl" destdir="build/classes-tests/wsdl" srcdestdir="build/test-src"/>
        <mkdir dir="${basedir}/build/wsdl/wsdl"/>
    	<copy todir="${basedir}/build/wsdl/wsdl">
            <fileset dir="${basedir}/test/wsdl">
            	<include name="**/*.wsdl"/>
            </fileset>
        </copy>
        <touch file="${basedir}/build/test-src/.TESTWSDL.CODEGEN.DONE"/>
    </target>

    <target name="testwsdl.codegen">
        <uptodate property="testwsdl.codegen.notrequired" value="true">
            <srcfiles dir="test/wsdl" includes="*"/>
            <srcfiles dir="etc/ant-inc" includes="codegen.xml"/>
            <mapper type="merge" to="${basedir}/build/test-src/.TESTWSDL.CODEGEN.DONE"/>
        </uptodate>
        <antcall target="testwsdl.codegen.internal"/>
    </target>

    <target name="codegen" depends="schemas.codegen,configuration.codegen,testwsdl.codegen,type_test.codegen" description="Generate all generated code"/>

    <macrodef name="beangen">
        <attribute name="output.dir"/>
        <attribute name="schema.files"/>
        <sequential>
            <java failonerror="true" classname="org.objectweb.celtix.bus.configuration.spring.BeanGenerator" fork="true" newenvironment="true">
                <classpath>
                    <path location="${basedir}/build/classes"/>
                    <path refid="jaxws.classpath"/>
                    <path location="${basedir}/schemas"/>
                </classpath>
                <sysproperty key="java.util.logging.config.file" value="${basedir}/etc/logging.properties"/>
                <arg line="-d"/>
                <arg value="@{output.dir}"/>
                <arg line="@{schema.files}"/>
             </java>
        </sequential>
    </macrodef>

    <target name="spring.codegen.internal" unless="spring.codegen.notrequired">
        <fileset dir="${basedir}" id="metadata.schemas">
            <include name="src/**/config-metadata/*-config.xml"/>
            <include name="build/src/**/config-metadata/*-config.xml"/>
        </fileset>
        <pathconvert pathsep=" " property="metadata.schema.files" refid="metadata.schemas"/> 
        <property name="output.dir" location="${basedir}/build/spring-src"/>
        <beangen output.dir="${output.dir}" schema.files="${metadata.schema.files}"/>
        <touch file="${basedir}/build/spring-src/.SPRING.CODEGEN.DONE"/>
    </target>
    
    <target name="spring.codegen" description="Generate Java Beans for use with Spring">
        <uptodate property="spring.codegen.notrequired" value="true">
            <srcfiles dir="src" includes="**/config-metadata/*-config.xml"/>
            <mapper type="merge" to="${basedir}/build/spring-src/.SPRING.CODEGEN.DONE"/>
        </uptodate>
        <antcall target="spring.codegen.internal"/>
    </target>

    <target name="spring.test.codegen.internal" unless="spring.test.codegen.notrequired">
        <fileset dir="${basedir}/test/unit" id="test.metadata.schemas">
            <include name="**/resources/top.xml"/>
            <include name="**/resources/leaf.xml"/>
        </fileset>
		  
        <pathconvert pathsep=" " property="test.metadata.schema.files" refid="test.metadata.schemas"/>
        <property name="output.dir" location="${basedir}/build/test-spring-src"/>
        <beangen output.dir="${output.dir}" schema.files="${test.metadata.schema.files}"/>
        <touch file="${basedir}/build/test-spring-src/.SPRING.TEST.CODEGEN.DONE"/>
    </target>

    <target name="spring.test.codegen" description="Generate Test Java Beans for use with Spring">
        <uptodate property="spring.test.codegen.notrequired" value="true">
            <srcfiles dir="test" includes="**/resources/leaf.xml"/>
            <srcfiles dir="test" includes="**/resources/top.xml"/>
            <mapper type="merge" to="${basedir}/build/test-spring-src/.SPRING.TEST.CODEGEN.DONE"/>
        </uptodate>
        <antcall target="spring.test.codegen.internal"/>
    </target>

    <target name="configuration.docgen" depends="configuration.codegen" description="Generate documentation from configuration metadata">
        <mkdir dir="${basedir}/build/doc"/>
        <xslt style="${basedir}/etc/transforms/config-doc.xsl" destdir="${basedir}/build/doc" basedir="${basedir}" includes="src/**/config-metadata/*-config.xml build/src/**/config-metadata/*-config.xml">
            <mapper>
            <chainedmapper>
                <mapper type="flatten"/>
                <mapper type="glob" from="*.xml" to="*.html"/>
            </chainedmapper>
            </mapper>
        </xslt>
    </target>

</project>
